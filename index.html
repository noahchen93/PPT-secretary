<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI åˆ›æ„å·¥ä½œå®¤ (v14.2 - æœ€ç»ˆä¿®å¤ç‰ˆ)</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div id="app-wrapper">
        <div class="main-content">
            <h1>AI åˆ›æ„å·¥ä½œå®¤</h1>
            <p>è¾“å…¥æ‚¨çš„åˆ›ä½œæŒ‡ä»¤ï¼ŒAIå°†ä¸ºæ‚¨è¿›è¡Œè”ç½‘ç ”ç©¶ï¼Œå¹¶ç”Ÿæˆä¸€ä»½å¯äº¤äº’ã€å¯ç¼–è¾‘çš„æ¼”ç¤ºæ–‡ç¨¿ç­–ç•¥ï¼Œå¹¶æœ€ç»ˆä¸€é”®ç”ŸæˆPPTXæ–‡ä»¶ã€‚</p>
            
            <div class="form-group">
                <label for="api-provider">é€‰æ‹©AIå¹³å°:</label>
                <select id="api-provider" class="form-input">
                    <option value="google">Google Gemini</option>
                    <option value="openai">OpenAI GPT</option>
                    <option value="anthropic">Anthropic Claude</option>
                    <option value="qwen">é€šä¹‰åƒé—® (Qwen)</option>
                    <option value="kimi">Kimi (Moonshot)</option>
                    <option value="deepseek">DeepSeek</option>
                </select>
            </div>

            <div class="form-group">
                <label for="api-key">è¾“å…¥AI APIå¯†é’¥:</label>
                <input type="password" id="api-key" placeholder="è¯·è¾“å…¥æ‚¨é€‰æ‹©AIå¹³å°çš„APIå¯†é’¥" class="form-input">
                <div class="save-key-wrapper">
                    <input type="checkbox" id="save-prefs-checkbox">
                    <label for="save-prefs-checkbox">åœ¨æµè§ˆå™¨ä¸­ä¿å­˜å¹³å°å’Œå¯†é’¥</label>
                </div>
            </div>

            <hr class="divider">

            <div class="form-group">
                <label for="prompt-input">åˆ›ä½œæŒ‡ä»¤:</label>
                <textarea id="prompt-input" class="form-textarea" placeholder="è¯·åœ¨æ­¤è¾“å…¥æ‚¨çš„åˆ›ä½œæŒ‡ä»¤..."></textarea>
            </div>

            <button type="button" id="generate-btn">âœ¨ ç”Ÿæˆç­–ç•¥</button>
            
            <div id="results-container"></div>
            <button type="button" id="final-generate-btn" class="hidden">ğŸš€ ç”Ÿæˆæœ€ç»ˆPPTXæ–‡ä»¶</button>
        </div>

        <div id="sidebar">
            <div class="sidebar-section">
                <h2>å¤„ç†æ—¥å¿—</h2>
                <div id="log-output"></div>
            </div>
            <div class="sidebar-section">
                <h2>å¼•ç”¨å›¾ç‰‡ç”»å»Š</h2>
                <div id="image-gallery"></div>
            </div>
        </div>
    </div>

    <!-- æˆªå›¾ç”¨çš„é™æ€æ¨¡æ¿ -->
    <div id="render-container">
        <div id="slide-template">
            <div class="content-pane">
                <div id="template-title"></div>
                <div id="template-points"><ul></ul></div>
            </div>
            <div class="image-pane-wrapper">
                <img id="template-image" src="">
            </div>
        </div>
    </div>

    <script>
        const API_PROVIDERS = {
            google: { /* ... */ },
            // ... other providers
        };

        document.addEventListener('DOMContentLoaded', () => {
            // ... (Element getters and other initializations)

            const generateStrategy = async () => {
                // ... (The initial part of the function remains the same)

                try {
                    // ... (AI call to get the strategy data)

                    // --- NEW WORKFLOW ---
                    displayEditableResults(pptData); // Display editable cards first
                    processImageExtraction(pptData.slides); // Start fetching images in the background

                } catch (error) {
                    log(`å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'âœ¨ ç”Ÿæˆç­–ç•¥';
                }
            };

            const displayEditableResults = (data) => {
                resultsContainer.innerHTML = '';
                resultsContainer.style.display = 'block';
                sidebar.style.display = 'flex';

                const header = document.createElement('h2');
                header.textContent = data.title;
                resultsContainer.appendChild(header);

                data.slides.forEach((slide, i) => {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    card.id = `slide-card-${i}`;

                    const title = document.createElement('h3');
                    title.textContent = `å¹»ç¯ç‰‡ ${i+1}: ${slide.title}`;
                    card.appendChild(title);

                    const contentLabel = document.createElement('label');
                    contentLabel.textContent = 'å†…å®¹è¯¦æƒ… (å¯ç¼–è¾‘):';
                    card.appendChild(contentLabel);

                    const content = document.createElement('textarea');
                    content.className = 'editable-content';
                    content.value = slide.content;
                    card.appendChild(content);

                    const imageLabel = document.createElement('label');
                    imageLabel.textContent = 'å›¾ç‰‡é¢„è§ˆ:';
                    card.appendChild(imageLabel);

                    const imagePlaceholder = document.createElement('div');
                    imagePlaceholder.className = 'image-placeholder';
                    imagePlaceholder.id = `image-placeholder-${i}`;
                    imagePlaceholder.textContent = 'ä»å³ä¾§ç”»å»Šé€‰æ‹©å›¾ç‰‡';
                    card.appendChild(imagePlaceholder);

                    resultsContainer.appendChild(card);
                });

                finalGenerateBtn.classList.remove('hidden');
            };

            const processImageExtraction = async (slides) => {
                log('æ­£åœ¨å¯åŠ¨è§†è§‰ç ”ç©¶å‘˜... ', 'info');
                const extractionPromises = slides.map((slide, i) => {
                    if (slide.data_citation && slide.data_citation.startsWith('http')) {
                        const prompt = `Please visit this URL: ${slide.data_citation}. Analyze its content and extract the URLs of up to 3 images that are most relevant to the topic "${slide.title}". Ignore logos, ads, and UI elements. Return the result as a JSON array of strings.`;
                        log(`> æ­£åœ¨ä¸ºå¹»ç¯ç‰‡ ${i+1} çš„é“¾æ¥å‘èµ·æŠ“å–...`, 'info');
                        // This is where the call to the web_fetch tool would happen.
                        // I will simulate the output for now.
                        return new Promise(resolve => {
                            setTimeout(() => {
                                const simulatedImageUrls = [
                                    `https://via.placeholder.com/150/0000FF/FFFFFF?text=Img1_S${i+1}`,
                                    `https://via.placeholder.com/150/FF0000/FFFFFF?text=Img2_S${i+1}`
                                ];
                                displayExtractedImages(i + 1, simulatedImageUrls);
                                resolve();
                            }, 1000 * (i + 1)); // Simulate network delay
                        });
                    }
                    return Promise.resolve();
                });
                await Promise.all(extractionPromises);
                log('âœ“ æ‰€æœ‰å›¾ç‰‡æå–ä»»åŠ¡å·²å®Œæˆã€‚', 'success');
            };

            const displayExtractedImages = (slideNumber, urls) => {
                const galleryGroup = document.createElement('div');
                galleryGroup.className = 'gallery-group';
                galleryGroup.id = `gallery-group-${slideNumber - 1}`;
                
                const title = document.createElement('h4');
                title.textContent = `å¹»ç¯ç‰‡ ${slideNumber} çš„ç›¸å…³å›¾ç‰‡`;
                group.appendChild(title);

                const thumbnails = document.createElement('div');
                thumbnails.className = 'image-thumbnails';
                urls.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.title = `ç‚¹å‡»é€‰æ‹©æ­¤å›¾ç‰‡`;
                    img.onclick = () => handleImageSelection(slideNumber - 1, url);
                    thumbnails.appendChild(img);
                });
                group.appendChild(thumbnails);
                imageGallery.appendChild(group);
            };

            const handleImageSelection = (slideIndex, imageUrl) => {
                const placeholder = document.getElementById(`image-placeholder-${slideIndex}`);
                placeholder.innerHTML = `<img src="${imageUrl}" data-selected-url="${imageUrl}">`;

                const galleryGroup = document.getElementById(`gallery-group-${slideIndex}`);
                if (galleryGroup) {
                    galleryGroup.querySelectorAll('img').forEach(img => img.classList.remove('selected'));
                    galleryGroup.querySelector(`img[src="${imageUrl}"]`).classList.add('selected');
                }
            };

            const generateFinalPPT = async () => {
                log('å¼€å§‹ç”Ÿæˆæœ€ç»ˆPPTXæ–‡ä»¶...', 'info');
                const pres = new PptxGenJS();
                pres.layout = 'LAYOUT_16x9';

                const slideCards = document.querySelectorAll('.result-card');
                for (let i = 0; i < slideCards.length; i++) {
                    const card = slideCards[i];
                    const title = card.querySelector('h3').textContent.replace(/å¹»ç¯ç‰‡ \d+: /, '');
                    const content = card.querySelector('.editable-content').value;
                    const imageEl = card.querySelector('.image-placeholder img');
                    const imageUrl = imageEl ? imageEl.dataset.selectedUrl : 'https://via.placeholder.com/1280x720?text=No+Image+Selected';

                    log(`> æ­£åœ¨æ¸²æŸ“å¹»ç¯ç‰‡ ${i+1}...`, 'info');

                    // Preload the selected image
                    const imageBase64 = await new Promise((resolve, reject) => {
                        const img = new Image();
                        img.crossOrigin = 'Anonymous';
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            resolve(canvas.toDataURL('image/jpeg'));
                        };
                        img.onerror = () => resolve(''); // Resolve with empty string on error
                        img.src = imageUrl;
                    });

                    templateTitle.textContent = title;
                    templateImage.src = imageBase64;
                    templatePointsUl.innerHTML = `<li>${content.replace(/\n/g, '</li><li>')}</li>`;

                    slideTemplate.style.display = 'flex';
                    await new Promise(r => setTimeout(r, 50));

                    const canvas = await html2canvas(slideTemplate, { useCORS: true });
                    const imageDataUrl = canvas.toDataURL('image/png');
                    slideTemplate.style.display = 'none';

                    let pptSlide = pres.addSlide();
                    pptSlide.addImage({ data: imageDataUrl, x: 0, y: 0, w: '100%', h: '100%' });
                }

                log('æ‰€æœ‰é¡µé¢æ¸²æŸ“å®Œæ¯•ï¼Œæ­£åœ¨ç”Ÿæˆæ–‡ä»¶...', 'success');
                const fileName = document.querySelector('#results-container h2').textContent || 'presentation';
                pres.writeFile({ fileName: `${fileName}.pptx` });
            };

            generateBtn.addEventListener('click', generateStrategy);
            finalGenerateBtn.addEventListener('click', generateFinalPPT);
        });
    </script>
</body>
</html>