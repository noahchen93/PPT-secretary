<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI PPT ç”Ÿæˆå™¨ (å¸¦æ—¥å¿—)</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div id="app-wrapper">
        <div class="main-content">
            <h1>AI ä¸€é”®ç”Ÿæˆ PPT</h1>
            <p>é€‰æ‹©ä¸€ä¸ªAIæ¨¡å‹ï¼Œè¾“å…¥æ‚¨çš„APIå¯†é’¥å’Œä¸»é¢˜ï¼Œå³å¯ä¸€é”®ç”Ÿæˆæ¼”ç¤ºæ–‡ç¨¿ã€‚</p>
            
            <div class="form-group">
                <label for="api-provider">é€‰æ‹©AIå¹³å°:</label>
                <select id="api-provider" class="form-input">
                    <option value="google">Google Gemini</option>
                    <option value="openai">OpenAI GPT</option>
                    <option value="anthropic">Anthropic Claude</option>
                    <option value="qwen">é€šä¹‰åƒé—® (Qwen)</option>
                    <option value="kimi">Kimi (Moonshot)</option>
                    <option value="deepseek">DeepSeek</option>
                </select>
            </div>

            <div class="form-group">
                <label for="api-key">è¾“å…¥APIå¯†é’¥:</label>
                <input type="password" id="api-key" placeholder="è¯·è¾“å…¥æ‚¨é€‰æ‹©å¹³å°çš„APIå¯†é’¥" class="form-input">
            </div>

            <div class="form-group">
                <label for="topic-input">è¾“å…¥ä¸»é¢˜:</label>
                <input type="text" id="topic-input" placeholder="ä¾‹å¦‚ï¼šé‡å­è®¡ç®—çš„åŸºæœ¬åŸç†" class="form-input">
            </div>
            <button type="button" id="generate-btn">âœ¨ ç‚¹å‡»ç”Ÿæˆ</button>
        </div>

        <div id="sidebar">
            <div class="sidebar-section">
                <h2>å¤„ç†æ—¥å¿—</h2>
                <div id="log-output"></div>
            </div>
            <div class="sidebar-section">
                <h2>ç”Ÿæˆå†…å®¹ (JSON)</h2>
                <pre id="code-output"><code>ç­‰å¾…AIè¿”å›å†…å®¹...</code></pre>
            </div>
        </div>
    </div>

    <div id="render-container" style="position: absolute; left: -9999px; top: -9999px; width: 1280px; height: 720px;"></div>

    <script>
        // --- API é…ç½®ä¸­å¿ƒ ---
        const API_PROVIDERS = {
            google: {
                url: (apiKey) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`,
                buildRequest: (prompt) => ({
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=utf-8' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                }),
                parseResponse: (data) => data.candidates[0].content.parts[0].text
            },
            openai: {
                url: () => `https://api.openai.com/v1/chat/completions`,
                buildRequest: (prompt, apiKey) => ({
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=utf-8', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "gpt-3.5-turbo", messages: [{ role: "user", content: prompt }] })
                }),
                parseResponse: (data) => data.choices[0].message.content
            },
            anthropic: {
                url: () => `https://api.anthropic.com/v1/messages`,
                buildRequest: (prompt, apiKey) => ({
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=utf-8', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01' },
                    body: JSON.stringify({ model: "claude-3-sonnet-20240229", max_tokens: 2048, messages: [{ role: "user", content: prompt }] })
                }),
                parseResponse: (data) => data.content[0].text
            },
            qwen: {
                url: () => `https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation`,
                buildRequest: (prompt, apiKey) => ({
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=utf-8', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "qwen-turbo", input: { prompt: prompt } })
                }),
                parseResponse: (data) => data.output.text
            },
            kimi: {
                url: () => `https://api.moonshot.cn/v1/chat/completions`,
                buildRequest: (prompt, apiKey) => ({
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=utf-8', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "moonshot-v1-8k", messages: [{ role: "user", content: prompt }] })
                }),
                parseResponse: (data) => data.choices[0].message.content
            },
            deepseek: {
                url: () => `https://api.deepseek.com/chat/completions`,
                buildRequest: (prompt, apiKey) => ({
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=utf-8', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "deepseek-chat", messages: [{ role: "user", content: prompt }] })
                }),
                parseResponse: (data) => data.choices[0].message.content
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const generateBtn = document.getElementById('generate-btn');
            const logOutput = document.getElementById('log-output');
            const codeOutput = document.querySelector('#code-output code');
            const renderContainer = document.getElementById('render-container');

            const log = (message, type = 'info') => {
                const p = document.createElement('p');
                p.textContent = message;
                p.className = `log-${type}`;
                logOutput.appendChild(p);
                logOutput.scrollTop = logOutput.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            };

            const logCode = (json) => {
                codeOutput.textContent = JSON.stringify(json, null, 2);
            };

            const clearLogs = () => {
                logOutput.innerHTML = '';
                codeOutput.textContent = 'ç­‰å¾…AIè¿”å›å†…å®¹...';
            };

            const callAI = async (topic, provider, apiKey) => {
                log(`æ­£åœ¨è¿æ¥ ${provider} çš„AIå¤§è„‘...`, 'info');
                if (!apiKey) throw new Error('å°šæœªæä¾›APIå¯†é’¥ã€‚');

                const providerConfig = API_PROVIDERS[provider];
                if (!providerConfig) throw new Error('é€‰æ‹©äº†æ— æ•ˆçš„AIå¹³å°ã€‚');

                const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼”ç¤ºæ–‡ç¨¿å†…å®¹ç­–åˆ’ä¸“å®¶ã€‚è¯·æ ¹æ®ä¸»é¢˜ "${topic}" ä¸ºæˆ‘ç”Ÿæˆä¸€ä¸ªå†…å®¹å¤§çº²ã€‚å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„è§£é‡Šæˆ–Markdownæ ‡è®°ï¼š{"title":"...","subtitle":"...","slides":[{"title":"...","search_term":"...","points":["...", ...]}, ...],"summary":{"title":"...","points":["...", "..."]}}`;
                
                const requestOptions = providerConfig.buildRequest(prompt, apiKey);
                const apiUrl = providerConfig.url(apiKey);

                const response = await fetch(apiUrl, requestOptions);
                if (!response.ok) throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                
                const data = await response.json();
                const jsonString = providerConfig.parseResponse(data).replace(/```json\n|```/g, '').trim();
                log('æˆåŠŸè·å–AIå†…å®¹å¤§çº²ã€‚', 'success');
                const parsedJson = JSON.parse(jsonString);
                logCode(parsedJson);
                return parsedJson;
            };

            const generatePPT = async () => {
                clearLogs();
                const topic = document.getElementById('topic-input').value;
                const provider = document.getElementById('api-provider').value;
                const apiKey = document.getElementById('api-key').value;

                if (!topic) { log('è¯·è¾“å…¥ä¸€ä¸ªä¸»é¢˜ï¼', 'error'); return; }

                generateBtn.disabled = true;
                generateBtn.textContent = 'ç”Ÿæˆä¸­ï¼Œè¯·åå’Œæ”¾å®½...';
                
                try {
                    const pptData = await callAI(topic, provider, apiKey);
                    log('å¼€å§‹ç”ŸæˆPPTé¡µé¢...', 'info');

                    const pres = new PptxGenJS();
                    pres.layout = 'LAYOUT_16x9';

                    // ... (æ­¤å¤„ç²˜è´´ä¹‹å‰ç‰ˆæœ¬ä¸­å®Œæ•´çš„PPTé¡µé¢ç”Ÿæˆé€»è¾‘) ...
                    // æ ‡é¢˜å¹»ç¯ç‰‡
                    log('æ­£åœ¨ç”Ÿæˆæ ‡é¢˜é¡µ...', 'info');
                    let titleSlide = pres.addSlide();
                    titleSlide.addText(pptData.title, { x: '5%', y: '40%', w: '90%', fontSize: 48, bold: true, align: 'center' });
                    titleSlide.addText(pptData.subtitle, { x: '5%', y: '55%', w: '90%', fontSize: 24, align: 'center' });

                    // å†…å®¹å¹»ç¯ç‰‡
                    for (let i = 0; i < pptData.slides.length; i++) {
                        const slideData = pptData.slides[i];
                        log(`æ­£åœ¨æ¸²æŸ“å¹»ç¯ç‰‡ ${i + 1}/${pptData.slides.length}: ${slideData.title}`, 'info');
                        
                        // æ¸²æŸ“HTMLç”¨äºæˆªå›¾
                        renderContainer.innerHTML = getSlideHtmlTemplate(slideData.title, slideData.points);
                        await new Promise(r => setTimeout(r, 100)); // ç­‰å¾…DOMæ›´æ–°

                        const canvas = await html2canvas(renderContainer.firstChild, { width: 1280, height: 720, scale: 1 });
                        const imageDataUrl = canvas.toDataURL('image/png');

                        let contentSlide = pres.addSlide();
                        contentSlide.addImage({ data: imageDataUrl, x: 0, y: 0, w: '100%', h: '100%' });
                    }

                    // æ€»ç»“å¹»ç¯ç‰‡
                    if (pptData.summary && pptData.summary.points.length > 0) {
                        log('æ­£åœ¨ç”Ÿæˆæ€»ç»“é¡µ...', 'info');
                        let summarySlide = pres.addSlide();
                        summarySlide.addText(pptData.summary.title, { x: 0.5, y: 0.5, w: '90%', h: 1, fontSize: 36, bold: true });
                        summarySlide.addText(pptData.summary.points.join('\n'), { x: 0.5, y: 1.5, w: '90%', h: '75%', fontSize: 24, bullet: true });
                    }

                    log('æ‰€æœ‰é¡µé¢æ¸²æŸ“å®Œæ¯•ï¼Œæ­£åœ¨ç”Ÿæˆ .pptx æ–‡ä»¶...', 'info');
                    await pres.writeFile({ fileName: `${topic.replace(/\s+/g, '_')}.pptx` });
                    log('ğŸ‰ ç”ŸæˆæˆåŠŸï¼å·²å¼€å§‹ä¸‹è½½ã€‚', 'success');

                } catch (error) {
                    log(`å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'âœ¨ ç‚¹å‡»ç”Ÿæˆ';
                }
            };

            const getSlideHtmlTemplate = (title, points) => {
                const pointsHtml = points.map(p => `<li>${p}</li>`).join('');
                const imageUrl = 'https://images.pexels.com/photos/356079/pexels-photo-356079.jpeg'; // é»˜è®¤èƒŒæ™¯å›¾
                return `
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap');
                        .slide { width: 1280px; height: 720px; display: flex; background-color: #ffffff; overflow: hidden; font-family: 'Noto Sans SC', sans-serif; }
                        .content-pane { width: 58%; padding: 50px 40px 50px 80px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; }
                        .title { font-size: 44px; font-weight: 700; color: #0d47a1; margin-bottom: 35px; line-height: 1.3; }
                        .points ul { list-style: none; padding-left: 0; margin: 0; }
                        .points li { font-size: 24px; color: #37474f; margin-bottom: 18px; padding-left: 35px; position: relative; line-height: 1.6; }
                        .points li::before { content: 'â—†'; position: absolute; left: 0; color: #1976d2; font-size: 20px; top: 5px; }
                        .image-pane { width: 42%; background-size: cover; background-position: center; clip-path: polygon(25% 0, 100% 0, 100% 100%, 0% 100%); }
                    </style>
                    <div class="slide">
                        <div class="content-pane">
                            <div class="title">${title}</div>
                            <div class="points"><ul>${pointsHtml}</ul></div>
                        </div>
                        <div class="image-pane" style="background-image: url('${imageUrl}');"></div>
                    </div>
                `;
            };

            generateBtn.addEventListener('click', generatePPT);
        });
    </script>
</body>
</html>